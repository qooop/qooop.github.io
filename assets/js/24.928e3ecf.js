(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{398:function(s,t,e){"use strict";e.r(t);var n=e(44),a=Object(n.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"使用chroot限制ssh用户"}},[s._v("使用chroot限制ssh用户")]),s._v(" "),e("h3",{attrs:{id:"环境准备"}},[s._v("环境准备")]),s._v(" "),e("p",[s._v("在阅读本文之前，需要准备一个可以chroot的系统；关于如何创建这样的系统，请参考另外一片文章"),e("RouterLink",{attrs:{to:"/blogs/2021100901.html"}},[s._v("《使用supermin5创建一个可以chroot的系统》")]),s._v("。")],1),s._v(" "),e("p",[s._v("假设您已经准备好了一个可以chroot的目录，本文中我们以“test系统”来称呼这个目录，并且test系统位于/data/chroot/test目录，本文以test用户为例，演示如何使用chroot限制test用户登录后的目录。")]),s._v(" "),e("h3",{attrs:{id:"创建登录用户"}},[s._v("创建登录用户")]),s._v(" "),e("p",[s._v("宿主机器增加test用户，并设置登录密码。-M参数表示不创建用户家目录。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("useradd")]),s._v(" -M "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("passwd")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("在test系统中增加test用户，并创建家目录。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方法1：chroot到test系统，再执行增加用户命令")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chroot")]),s._v(" /data/chroot/test\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("useradd")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方法2：直接在宿主机器上执行增加用户命令并指定-R/--root参数")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("useradd")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -R /data/chroot/test\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("blockquote",[e("p",[s._v("-R, --root参数指定test系统的目录，表示修改此目录下的相关配置文件")])]),s._v(" "),e("h3",{attrs:{id:"sshd服务配置"}},[s._v("sshd服务配置")]),s._v(" "),e("p",[s._v("修改宿主机器的sshd服务配置文件/etc/ssh/sshd_config，在文件末尾增加以下代码。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("Match User "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n    ChrootDirectory /data/chroot/test\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("Match User表示匹配用户，此处匹配test用户。")]),s._v(" "),e("li",[s._v("Match下方的配置是该用户特有的配置，所以这段配置一定要放在文件末尾，此处缩进一格方便查看。")]),s._v(" "),e("li",[s._v("ChrootDirectory表示开启chroot功能并指定test系统所在目录。")])]),s._v(" "),e("p",[s._v("修改完成后，重启sshd服务。")]),s._v(" "),e("blockquote",[e("p",[s._v("重启sshd服务之前，务必保证有其他方式可以获取到服务器的shell，防止sshd服务重启失败导致无法连接到服务器的尴尬情况😅。")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" sshd restart\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者")]),s._v("\nsystemctl restart sshd.service\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("如果需要将多个用户限制在不同或相同目录，重复以上两步骤，配置多个Match User片段即可实现。")]),s._v(" "),e("h3",{attrs:{id:"修改-dev-null文件权限"}},[s._v("修改/dev/null文件权限")]),s._v(" "),e("p",[s._v("完成以上步骤后，其实test用户就已经可以登录了，只是登录后shell会报错：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("» ssh test@localhost\ntest@localhost's password: \nLast login: Sun Oct 31 18:39:30 2021 from gateway\n-bash: /dev/null: Permission denied\n-bash: /dev/null: Permission denied\n-bash: /dev/null: Permission denied\n-bash: /dev/null: Permission denied\n-bash: /dev/null: Permission denied\n-bash: /dev/null: Permission denied\n-bash: /dev/null: Permission denied\n-bash: /dev/null: Permission denied\n-bash: /dev/null: Permission denied\n[test@localhost ~]$ \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("解决这个问题，只需要修改/dev/null的权限为任何人可以读写即可。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chroot")]),s._v(" /data/chroot/test\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("777")]),s._v(" /dev/null\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("(完)")])])}),[],!1,null,null,null);t.default=a.exports}}]);