(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{395:function(s,e,n){"use strict";n.r(e);var a=n(44),t=Object(a.a)({},(function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"使用supermin5创建一个可以chroot的系统"}},[s._v("使用supermin5创建一个可以chroot的系统")]),s._v(" "),n("p",[s._v("由于centos6中的febootstrap在centos7中已经找不到了，经过github上搜索发现，febootstrap在centos7中已经被supermin替代了，在centos7中建议使用supermin来创建可以chroot切换根的系统，此方法同样适用于创建docker镜像。")]),s._v(" "),n("h3",{attrs:{id:"chroot介绍"}},[s._v("chroot介绍")]),s._v(" "),n("p",[s._v("chroot命令是change root directory的缩写，以指定的新根为运行指定命令时的的根目录。Linux系统默认的根目录是/，使用chroot指定新的根后，系统将以指定的目录作为根目录（/），根以外的目录将无法访问。")]),s._v(" "),n("h3",{attrs:{id:"supermin介绍"}},[s._v("supermin介绍")]),s._v(" "),n("p",[s._v("supermin是一个可以创建docker镜像的工具，分为supermin和supermin5两个版本，本文使用的是supermin5。")]),s._v(" "),n("h3",{attrs:{id:"supermin安装"}},[s._v("supermin安装")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("yum "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y supermin5\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("supermin的使用方法如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[root@localhost ~]# supermin5 --help\nsupermin - tool for creating supermin appliances\nCopyright (C) 2009-2014 Red Hat Inc.\n\nUsage:\n\n  supermin --prepare LIST OF PACKAGES ...\n  supermin --build INPUT [INPUT ...]\n\nFor full instructions, read the supermin(1) man page.\n\nOptions:\n\n  --build                      Build a full appliance\n  --copy-kernel                Copy kernel instead of symlinking\n  --dtb                        Obsolete option, do not use\n  -f chroot|ext2               Set output format\n  --format                     -"-\n  --host-cpu ARCH              Set host CPU architecture\n  --if-newer                   Only build if needed\n  --include-packagelist        Add a file with the list of packages\n  --list-drivers               Display list of drivers and exit\n  --lock LOCKFILE              Use a lock file\n  --names                      Give an error for people needing supermin 4\n  -o OUTPUTDIR                 Set output directory\n  --packager-config CONFIGFILE Set packager config file\n  --prepare                    Prepare a supermin appliance\n  --size                       Set the size of the ext2 filesystem\n  --use-installed              Use installed files instead of accessing network\n  -v                           Enable debugging messages\n  --verbose                    -"-\n  -V                           Display version and exit\n  --version                    -"-\n  -help                        Display this list of options\n  --help                       Display this list of options\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("h3",{attrs:{id:"创建镜像"}},[s._v("创建镜像")]),s._v(" "),n("p",[s._v("创建镜像分为两部分，第一部分准备需要安装的包，第二部分构建镜像。完整命令如下：")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("supermin5 -v --prepare "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" yum net-tools initscripts "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" coreutils -o supermin.d\nsupermin5 -v --build -f "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chroot")]),s._v(" supermin.d -o "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ul",[n("li",[n("p",[s._v("-v参数表示打印debug信息")])]),s._v(" "),n("li",[n("p",[s._v("--prepare参数表示需要准备的包列表")])]),s._v(" "),n("li",[n("p",[s._v("-o是输出的命令，完成后分别会在当前目录生成supermin.d目录和test目录")])]),s._v(" "),n("li",[n("p",[s._v("-f是输出格式")])])]),s._v(" "),n("h3",{attrs:{id:"使用chroot切换根"}},[s._v("使用chroot切换根")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chroot")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"优化和设置"}},[s._v("优化和设置")]),s._v(" "),n("p",[s._v("chroot后的系统因为/dev和/proc目录是空的，会导致一些命令出现问题。以下命令如无特殊说明，都在chroot后的系统中执行。")]),s._v(" "),n("p",[s._v("创建/dev目录下的文件")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mknod")]),s._v(" -m "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("666")]),s._v(" /dev/random c "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mknod")]),s._v(" -m "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("666")]),s._v(" /dev/urandom c "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("挂载/proc目录")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" -t proc proc /proc\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("yum变量设置")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/yum/vars/releasever\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("网络配置(宿主机器上执行)")]),s._v(" "),n("p",[s._v("复制宿主机器的/etc/resolve.conf到chroot系统下")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /etc/resolve.conf test/etc/\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"卸载"}},[s._v("卸载")]),s._v(" "),n("p",[s._v("卸载之前，需要将挂载的目录取消。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在chroot中执行：")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("umount")]),s._v(" /proc\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者在宿主机器中执行：")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("umount")]),s._v(" test/proc\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("然后退出chroot系统，在宿主机器中删除整个目录即可。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -fr "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(完)")])])}),[],!1,null,null,null);e.default=t.exports}}]);